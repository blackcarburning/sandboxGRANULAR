<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Granular Synthesizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @media screen and (orientation: portrait) {
            html {
                transform: rotate(90deg);
                transform-origin: left top;
                width: 100vh;
                height: 100vw;
                overflow-x: hidden;
                position: absolute;
                top: 100%;
                left: 0;
            }
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:  linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            height: 100vh;
            width: 100vw;
            overflow:  hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        . synth-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 10px;
            padding-bottom: 0;
        }

        .top-section {
            display: flex;
            gap: 10px;
            flex:  1;
            min-height: 0;
            overflow: hidden;
        }

        .recording-section {
            flex: 0 0 200px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .recording-section h2 {
            color: #00d4ff;
            font-size: 14px;
            margin-bottom:  5px;
        }

        . recording-buttons {
            display: flex;
            gap: 5px;
        }

        button {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: manipulation;
        }

        #recordBtn {
            background: linear-gradient(135deg, #ff0844 0%, #ff6b6b 100%);
            color: white;
            flex:  1;
        }

        #recordBtn. recording {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #clearBtn {
            background: linear-gradient(135deg, #666 0%, #888 100%);
            color:  white;
        }

        #waveformCanvas {
            width: 100%;
            flex: 1;
            min-height: 60px;
            background: #0a0a15;
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .status {
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            text-align: center;
            color: #00d4ff;
            font-size: 10px;
        }

        .controls-section {
            flex: 1;
            display:  grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            overflow:  hidden;
        }

        . control-group {
            display:  flex;
            flex-direction:  column;
            gap: 4px;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #b0b0b0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        . control-group . value {
            color: #00d4ff;
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(0, 212, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance:  none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius:  50%;
            background: #00d4ff;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius:  50%;
            background: #00d4ff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
        }

        . keyboard-section {
            flex: 0 0 120px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding: 5px 0;
            background: rgba(20, 20, 40, 0.9);
            border-top: 2px solid rgba(0, 212, 255, 0.3);
        }

        .keyboard {
            display: flex;
            position: relative;
            height: 110px;
        }

        .key {
            position: relative;
            cursor: pointer;
            border-radius: 0 0 6px 6px;
            transition: all 0.05s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            font-size:  9px;
            font-weight:  bold;
            touch-action: none;
        }

        .key.white {
            width: 36px;
            height: 110px;
            background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
            border: 1px solid #999;
            color: #333;
            z-index: 1;
            margin:  0 1px;
        }

        . key.black {
            width: 24px;
            height: 70px;
            background: linear-gradient(to bottom, #333 0%, #000000 100%);
            border:  1px solid #000;
            color: #fff;
            position: absolute;
            z-index: 2;
            font-size: 7px;
        }

        .key.white: active, .key.white.active {
            background: linear-gradient(to bottom, #00d4ff 0%, #0099cc 100%);
            transform: translateY(2px);
        }

        .key.black:active, .key.black.active {
            background: linear-gradient(to bottom, #00a0cc 0%, #006688 100%);
            transform:  translateY(2px);
        }

        .key-label {
            font-size: 7px;
            opacity: 0.6;
        }

        /* Position black keys for 2 octaves */
        .key. black[data-note="C#1"] { left: 26px; }
        .key. black[data-note="D#1"] { left: 64px; }
        .key. black[data-note="F#1"] { left: 140px; }
        .key. black[data-note="G#1"] { left: 178px; }
        .key. black[data-note="A#1"] { left: 216px; }
        .key. black[data-note="C#2"] { left: 292px; }
        .key. black[data-note="D#2"] { left: 330px; }
        .key. black[data-note="F#2"] { left: 406px; }
        .key. black[data-note="G#2"] { left: 444px; }
        .key. black[data-note="A#2"] { left: 482px; }
    </style>
</head>
<body>
    <div class="synth-container">
        <div class="top-section">
            <div class="recording-section">
                <h2>ðŸŽ¤ Recording</h2>
                <div class="recording-buttons">
                    <button id="recordBtn">Record</button>
                    <button id="clearBtn">Clear</button>
                </div>
                <canvas id="waveformCanvas"></canvas>
                <div id="status" class="status">No audio recorded</div>
            </div>

            <div class="controls-section">
                <div class="control-group">
                    <label><span>Grain Size</span><span class="value" id="grainSizeValue">100ms</span></label>
                    <input type="range" id="grainSize" min="10" max="500" value="100" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Density</span><span class="value" id="densityValue">5</span></label>
                    <input type="range" id="density" min="1" max="20" value="5" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Position</span><span class="value" id="positionValue">0%</span></label>
                    <input type="range" id="position" min="0" max="100" value="0" step="0.1">
                </div>
                
                <div class="control-group">
                    <label><span>Spray</span><span class="value" id="sprayValue">0%</span></label>
                    <input type="range" id="spray" min="0" max="100" value="0" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Attack</span><span class="value" id="attackValue">10ms</span></label>
                    <input type="range" id="attack" min="1" max="100" value="10" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Release</span><span class="value" id="releaseValue">50ms</span></label>
                    <input type="range" id="release" min="1" max="200" value="50" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Pitch Var</span><span class="value" id="pitchVarValue">0%</span></label>
                    <input type="range" id="pitchVar" min="0" max="100" value="0" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Pan Spread</span><span class="value" id="panSpreadValue">0%</span></label>
                    <input type="range" id="panSpread" min="0" max="100" value="0" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Reverb</span><span class="value" id="reverbValue">0%</span></label>
                    <input type="range" id="reverb" min="0" max="100" value="0" step="1">
                </div>
                
                <div class="control-group">
                    <label><span>Volume</span><span class="value" id="volumeValue">80%</span></label>
                    <input type="range" id="volume" min="0" max="100" value="80" step="1">
                </div>
            </div>
        </div>

        <div class="keyboard-section">
            <div class="keyboard">
                <!-- Octave 1 -->
                <div class="key white" data-note="C1">C</div>
                <div class="key black" data-note="C#1">C#</div>
                <div class="key white" data-note="D1">D</div>
                <div class="key black" data-note="D#1">D#</div>
                <div class="key white" data-note="E1">E</div>
                <div class="key white" data-note="F1">F</div>
                <div class="key black" data-note="F#1">F#</div>
                <div class="key white" data-note="G1">G</div>
                <div class="key black" data-note="G#1">G#</div>
                <div class="key white" data-note="A1">A</div>
                <div class="key black" data-note="A#1">A#</div>
                <div class="key white" data-note="B1">B</div>
                <!-- Octave 2 -->
                <div class="key white" data-note="C2">C</div>
                <div class="key black" data-note="C#2">C#</div>
                <div class="key white" data-note="D2">D</div>
                <div class="key black" data-note="D#2">D#</div>
                <div class="key white" data-note="E2">E</div>
                <div class="key white" data-note="F2">F</div>
                <div class="key black" data-note="F#2">F#</div>
                <div class="key white" data-note="G2">G</div>
                <div class="key black" data-note="G#2">G#</div>
                <div class="key white" data-note="A2">A</div>
                <div class="key black" data-note="A#2">A#</div>
                <div class="key white" data-note="B2">B</div>
            </div>
        </div>
    </div>

    <script>
        // Prevent default touch behaviors
        document.addEventListener('touchmove', function(e) {
            if (e.target.type !== 'range') {
                e.preventDefault();
            }
        }, { passive: false });

        // Audio Context
        let audioContext;
        let audioBuffer = null;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let activeGrains = new Map();
        let reverbNode = null;
        let dryGainNode = null;
        let wetGainNode = null;

        // Note frequencies (C1 = 32. 7 Hz as base)
        const noteFrequencies = {
            'C1': 32.70, 'C#1': 34.65, 'D1':  36.71, 'D#1': 38.89,
            'E1': 41.20, 'F1': 43.65, 'F#1': 46.25, 'G1':  49.00,
            'G#1': 51.91, 'A1': 55.00, 'A#1': 58.27, 'B1': 61.74,
            'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78,
            'E2': 82.41, 'F2': 87.31, 'F#2': 92.50, 'G2': 98.00,
            'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47
        };

        const baseFrequency = 65.41; // C2 as reference

        // Initialize Audio Context
        async function initAudio() {
            if (! audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await setupReverb();
            }
            if (audioContext. state === 'suspended') {
                await audioContext.resume();
            }
        }

        // Setup Reverb
        async function setupReverb() {
            reverbNode = audioContext.createConvolver();
            dryGainNode = audioContext. createGain();
            wetGainNode = audioContext.createGain();
            
            // Create impulse response for reverb
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * 2;
            const impulse = audioContext.createBuffer(2, length, sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
            }
            
            reverbNode.buffer = impulse;
            dryGainNode. connect(audioContext.destination);
            reverbNode.connect(wetGainNode);
            wetGainNode.connect(audioContext. destination);
            
            updateReverb();
        }

        function updateReverb() {
            const reverbAmount = document.getElementById('reverb').value / 100;
            if (dryGainNode && wetGainNode) {
                dryGainNode.gain.value = 1 - reverbAmount * 0.5;
                wetGainNode. gain.value = reverbAmount;
            }
        }

        // Recording functions
        async function startRecording() {
            await initAudio();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data. size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const arrayBuffer = await blob.arrayBuffer();
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    drawWaveform();
                    document.getElementById('status').textContent = 
                        `Recorded: ${audioBuffer.duration.toFixed(2)}s`;
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder. start();
                isRecording = true;
                document.getElementById('recordBtn').textContent = 'Stop';
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('status').textContent = 'Recording...';
            } catch (err) {
                console.error('Error accessing microphone:', err);
                document. getElementById('status').textContent = 'Microphone access denied';
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder. stop();
                isRecording = false;
                document.getElementById('recordBtn').textContent = 'Record';
                document.getElementById('recordBtn').classList.remove('recording');
            }
        }

        function clearRecording() {
            audioBuffer = null;
            recordedChunks = [];
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            document.getElementById('status').textContent = 'No audio recorded';
            stopAllGrains();
        }

        // Draw waveform
        function drawWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, width, height);
            
            if (! audioBuffer) return;
            
            const data = audioBuffer.getChannelData(0);
            const step = Math.ceil(data.length / width);
            const amp = height / 2;
            
            ctx.strokeStyle = '#00d4ff';
            ctx. lineWidth = 1;
            ctx.beginPath();
            
            for (let i = 0; i < width; i++) {
                let min = 1.0, max = -1.0;
                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                ctx.moveTo(i, (1 + min) * amp);
                ctx. lineTo(i, (1 + max) * amp);
            }
            
            ctx.stroke();
        }

        // Granular synthesis
        function playGrain(note) {
            if (!audioBuffer || !audioContext) return null;
            
            const grainSize = document.getElementById('grainSize').value / 1000;
            const position = document.getElementById('position').value / 100;
            const spray = document.getElementById('spray').value / 100;
            const attack = document.getElementById('attack').value / 1000;
            const release = document.getElementById('release').value / 1000;
            const pitchVar = document.getElementById('pitchVar').value / 100;
            const panSpread = document.getElementById('panSpread').value / 100;
            const volume = document.getElementById('volume').value / 100;
            
            const noteFreq = noteFrequencies[note];
            const playbackRate = noteFreq / baseFrequency;
            
            const maxOffset = Math.max(0, audioBuffer.duration - grainSize);
            const baseOffset = position * maxOffset;
            const sprayOffset = (Math.random() - 0.5) * spray * maxOffset;
            const startOffset = Math.max(0, Math.min(maxOffset, baseOffset + sprayOffset));
            
            const pitchMultiplier = 1 + (Math.random() - 0.5) * pitchVar * 0.5;
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.playbackRate.value = playbackRate * pitchMultiplier;
            
            const gainNode = audioContext.createGain();
            const panNode = audioContext.createStereoPanner();
            
            panNode.pan.value = (Math.random() - 0.5) * 2 * panSpread;
            
            source.connect(gainNode);
            gainNode.connect(panNode);
            panNode.connect(dryGainNode);
            panNode.connect(reverbNode);
            
            const now = audioContext.currentTime;
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(volume, now + attack);
            gainNode.gain.linearRampToValueAtTime(volume, now + grainSize - release);
            gainNode.gain.linearRampToValueAtTime(0, now + grainSize);
            
            source.start(now, startOffset, grainSize);
            
            return { source, gainNode, panNode };
        }

        function startGrainStream(note) {
            if (!audioBuffer) return;
            
            const density = document.getElementById('density').value;
            const interval = 1000 / density;
            
            const grainStream = {
                intervalId: null,
                grains: []
            };
            
            function scheduleGrain() {
                const grain = playGrain(note);
                if (grain) {
                    grainStream.grains.push(grain);
                    // Clean up old grains
                    grainStream.grains = grainStream.grains.slice(-20);
                }
            }
            
            scheduleGrain();
            grainStream.intervalId = setInterval(scheduleGrain, interval);
            
            activeGrains.set(note, grainStream);
        }

        function stopGrainStream(note) {
            const grainStream = activeGrains.get(note);
            if (grainStream) {
                clearInterval(grainStream.intervalId);
                activeGrains.delete(note);
            }
        }

        function stopAllGrains() {
            activeGrains.forEach((stream, note) => {
                clearInterval(stream.intervalId);
            });
            activeGrains. clear();
        }

        // Event Listeners
        document.getElementById('recordBtn').addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        document.getElementById('clearBtn').addEventListener('click', clearRecording);

        // Slider value displays
        const sliders = [
            { id: 'grainSize', valueId: 'grainSizeValue', suffix: 'ms' },
            { id: 'density', valueId: 'densityValue', suffix: '' },
            { id: 'position', valueId: 'positionValue', suffix: '%' },
            { id: 'spray', valueId: 'sprayValue', suffix: '%' },
            { id: 'attack', valueId: 'attackValue', suffix: 'ms' },
            { id:  'release', valueId: 'releaseValue', suffix: 'ms' },
            { id: 'pitchVar', valueId: 'pitchVarValue', suffix: '%' },
            { id: 'panSpread', valueId: 'panSpreadValue', suffix: '%' },
            { id: 'reverb', valueId: 'reverbValue', suffix: '%', onChange: updateReverb },
            { id: 'volume', valueId: 'volumeValue', suffix: '%' }
        ];

        sliders.forEach(slider => {
            const element = document.getElementById(slider. id);
            const valueElement = document.getElementById(slider.valueId);
            
            element. addEventListener('input', () => {
                valueElement.textContent = element.value + slider. suffix;
                if (slider.onChange) slider.onChange();
            });
        });

        // Keyboard interaction
        const keys = document.querySelectorAll('.key');

        keys.forEach(key => {
            const note = key.dataset.note;
            
            // Mouse events
            key.addEventListener('mousedown', async (e) => {
                e.preventDefault();
                await initAudio();
                key.classList.add('active');
                startGrainStream(note);
            });
            
            key.addEventListener('mouseup', () => {
                key.classList.remove('active');
                stopGrainStream(note);
            });
            
            key.addEventListener('mouseleave', () => {
                key.classList. remove('active');
                stopGrainStream(note);
            });
            
            // Touch events
            key.addEventListener('touchstart', async (e) => {
                e.preventDefault();
                await initAudio();
                key.classList. add('active');
                startGrainStream(note);
            }, { passive: false });
            
            key.addEventListener('touchend', (e) => {
                e. preventDefault();
                key.classList. remove('active');
                stopGrainStream(note);
            }, { passive: false });
            
            key.addEventListener('touchcancel', (e) => {
                e. preventDefault();
                key.classList. remove('active');
                stopGrainStream(note);
            }, { passive: false });
        });

        // Resize handler
        window.addEventListener('resize', () => {
            if (audioBuffer) {
                drawWaveform();
            }
        });

        // Initialize canvas
        window.addEventListener('load', () => {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas. offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window. devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
        });
    </script>
</body>
</html>
